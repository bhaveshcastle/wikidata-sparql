CREATE ROLE ds_user WITH LOGIN ENCRYPTED PASSWORD 'ds_pass' CREATEDB ;
CREATE DATABASE ds WITH OWNER ds_user TEMPLATE template0 ENCODING 'UTF8';
GRANT ALL PRIVILEGES ON DATABASE ds TO ds_user ;


CREATE TABLE IF NOT EXISTS ds_type (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
CREATE UNIQUE INDEX CONCURRENTLY ds_type_name ON ds_type (lower(name)) ;
GRANT ALL PRIVILEGES ON TABLE ds_type TO ds_user ;
GRANT ALL PRIVILEGES ON SEQUENCE ds_type_id_seq TO ds_user ;

CREATE TABLE IF NOT EXISTS ds_label (
  id SERIAL PRIMARY KEY,
  label TEXT NOT NULL,
  type INTEGER NOT NULL REFERENCES ds_type(id) ON DELETE CASCADE,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
GRANT ALL PRIVILEGES ON TABLE ds_label TO ds_user ;
GRANT ALL PRIVILEGES ON SEQUENCE ds_label_id_seq TO ds_user ;
CREATE UNIQUE INDEX CONCURRENTLY ds_label_type ON ds_label (lower(label), type) ;

CREATE TABLE IF NOT EXISTS ds_image_data (
  image_url TEXT NOT NULL,
  type INTEGER NOT NULL REFERENCES ds_type(id) ON DELETE CASCADE,
  label_id INTEGER NOT NULL REFERENCES ds_label(id),
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
GRANT ALL PRIVILEGES ON TABLE ds_image_data TO ds_user ;
CREATE UNIQUE INDEX CONCURRENTLY ds_image_data_image_url_type_label ON ds_image_data (image_url, type, label_id) ;
CREATE INDEX CONCURRENTLY ON ds_image_data (created_at DESC);